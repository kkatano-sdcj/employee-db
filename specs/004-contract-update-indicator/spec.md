# Feature Specification: 契約満了予定日超過時の「要更新」表示機能

**Feature Branch**: `004-contract-update-indicator`  
**Created**: 2025-11-18  
**Status**: Draft  
**Input**: User description: "契約満了予定日が当日の日付を過ぎている契約は、契約管理画面と従業員管理ページ/従業員詳細ページに「要更新」と表示させるように仕様を変更してください。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 契約管理画面での「要更新」表示 (Priority: P1)

統括人事管理者が契約管理画面を表示した際、契約満了予定日が当日の日付を過ぎている契約に「要更新」の表示がされる。

**Why this priority**: 契約管理画面は契約の一覧を確認する主要な画面であり、更新が必要な契約を一目で識別できることが重要です。これにより、契約更新の見逃しを防ぎ、適切なタイミングで契約更新手続きを開始できます。

**Independent Test**: 統括人事管理者が契約管理画面を表示し、契約満了予定日が過去の日付になっている契約に「要更新」の表示がされることを確認します。この機能単体で、更新が必要な契約を視覚的に識別できる価値を提供します。

**Acceptance Scenarios**:

1. **Given** 契約管理画面が表示されている, **When** 契約満了予定日（employment_expiry_scheduled_date）が当日の日付を過ぎている契約が存在する, **Then** その契約に「要更新」の表示がされる
2. **Given** 契約管理画面が表示されている, **When** 契約満了予定日が当日または未来の日付の契約が存在する, **Then** その契約に「要更新」の表示はされない
3. **Given** 契約管理画面が表示されている, **When** 契約満了予定日が設定されていない契約が存在する, **Then** その契約に「要更新」の表示はされない
4. **Given** 契約管理画面が表示されている, **When** 「要更新」表示がされている契約をクリックする, **Then** 契約詳細画面に遷移し、契約情報が表示される

---

### User Story 2 - 従業員詳細ページでの「要更新」表示 (Priority: P1)

統括人事管理者または現場マネージャーが従業員詳細ページを表示した際、その従業員に関連する契約で契約満了予定日が当日の日付を過ぎているものに「要更新」の表示がされる。

**Why this priority**: 従業員詳細ページは個別の従業員情報を確認する主要な画面であり、その従業員の契約更新が必要かどうかを確認できることが重要です。契約管理画面と同様に、更新が必要な契約を視覚的に識別できる価値を提供します。

**Independent Test**: 統括人事管理者または現場マネージャーが従業員詳細ページを表示し、その従業員の契約で契約満了予定日が過去の日付になっているものに「要更新」の表示がされることを確認します。この機能単体で、個別の従業員の契約更新状況を確認できる価値を提供します。

**Acceptance Scenarios**:

1. **Given** 従業員詳細ページが表示されている, **When** その従業員に関連する契約で契約満了予定日が当日の日付を過ぎている契約が存在する, **Then** その契約に「要更新」の表示がされる
2. **Given** 従業員詳細ページが表示されている, **When** その従業員に関連する契約で契約満了予定日が当日または未来の日付の契約が存在する, **Then** その契約に「要更新」の表示はされない
3. **Given** 従業員詳細ページが表示されている, **When** その従業員に関連する契約で契約満了予定日が設定されていない契約が存在する, **Then** その契約に「要更新」の表示はされない
4. **Given** 従業員詳細ページが表示されている, **When** 複数の契約が存在し、一部の契約のみが契約満了予定日を過ぎている, **Then** 満了予定日を過ぎている契約のみに「要更新」の表示がされる

---

### User Story 3 - 従業員管理ページでの「要更新」表示 (Priority: P2)

統括人事管理者または現場マネージャーが従業員管理ページ（一覧ページ）を表示した際、契約満了予定日が当日の日付を過ぎている契約を持つ従業員に「要更新」の表示がされる。

**Why this priority**: 従業員一覧画面で更新が必要な契約を持つ従業員を一括で確認できることで、効率的に契約更新作業を進められます。ただし、個別の契約管理画面や従業員詳細ページでの表示が優先されるため、P2とします。

**Independent Test**: 統括人事管理者または現場マネージャーが従業員管理ページを表示し、契約満了予定日が過去の日付になっている契約を持つ従業員に「要更新」の表示がされることを確認します。この機能単体で、更新が必要な契約を持つ従業員を一覧で識別できる価値を提供します。

**Acceptance Scenarios**:

1. **Given** 従業員管理ページが表示されている, **When** 契約満了予定日が当日の日付を過ぎている契約を持つ従業員が存在する, **Then** その従業員に「要更新」の表示がされる
2. **Given** 従業員管理ページが表示されている, **When** 契約満了予定日が当日または未来の日付の契約のみを持つ従業員が存在する, **Then** その従業員に「要更新」の表示はされない
3. **Given** 従業員管理ページが表示されている, **When** 契約が存在しない従業員が存在する, **Then** その従業員に「要更新」の表示はされない
4. **Given** 従業員管理ページが表示されている, **When** 「要更新」表示がされている従業員をクリックする, **Then** 従業員詳細ページに遷移し、契約情報が表示される

---

### Edge Cases

- 契約満了予定日が当日（00:00:00）の場合、「要更新」は表示されない（当日を過ぎた時点で表示）
- 複数の契約を持つ従業員で、一部の契約のみが契約満了予定日を過ぎている場合、従業員管理ページでは「要更新」が表示される（少なくとも1つの契約が満了予定日を過ぎている場合）
- タイムゾーンの違いによる日付判定の影響（システムのタイムゾーン設定に基づいて判定）
- 契約満了予定日がNULLの場合、「要更新」は表示されない
- 実際の雇用満了日（employment_expiry_date）が設定されている場合でも、契約満了予定日が過去であれば「要更新」が表示される（予定日ベースで判定）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは契約管理画面で、契約満了予定日（employment_expiry_scheduled_date）が当日の日付を過ぎている契約に「要更新」の表示をすること。
- **FR-002**: システムは従業員詳細ページで、その従業員に関連する契約のうち、契約満了予定日が当日の日付を過ぎている契約に「要更新」の表示をすること。
- **FR-003**: システムは従業員管理ページ（一覧ページ）で、契約満了予定日が当日の日付を過ぎている契約を持つ従業員に「要更新」の表示をすること。
- **FR-004**: システムは「要更新」の判定を、契約満了予定日（employment_expiry_scheduled_date）が当日の日付（00:00:00）より前の日付である場合に行うこと。当日の日付は「要更新」の対象としないこと。
- **FR-005**: システムは契約満了予定日が設定されていない（NULL）契約に対しては「要更新」の表示をしないこと。
- **FR-006**: システムは「要更新」の表示が視覚的に識別しやすい形式（例：バッジ、ラベル、色分けなど）で行うこと。
- **FR-007**: システムは「要更新」の表示がされている契約または従業員をクリックした場合、適切な詳細画面に遷移できること。

### Key Entities *(include if feature involves data)*

- **契約（Contract）**: 雇用契約を表し、以下の日付フィールドを含む：
  - `employment_expiry_scheduled_date` (DATE): 雇用満了予定日（契約時に設定する予定の満了日）
  - このフィールドが当日の日付を過ぎている場合、「要更新」の表示対象となる
  - 注記: 実際の雇用満了日（employment_expiry_date）の有無は「要更新」の判定には影響しない

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 契約管理画面で、契約満了予定日が当日の日付を過ぎている契約に対して100%の精度で「要更新」の表示がされること
- **SC-002**: 従業員詳細ページで、契約満了予定日が当日の日付を過ぎている契約に対して100%の精度で「要更新」の表示がされること
- **SC-003**: 従業員管理ページで、契約満了予定日が当日の日付を過ぎている契約を持つ従業員に対して100%の精度で「要更新」の表示がされること
- **SC-004**: 契約満了予定日が当日または未来の日付の契約に対して、「要更新」の表示がされないこと（100%の精度）
- **SC-005**: 契約満了予定日が設定されていない契約に対して、「要更新」の表示がされないこと（100%の精度）
- **SC-006**: 統括人事管理者が契約管理画面を表示してから、更新が必要な契約を識別するまでの時間が3秒以内であること
- **SC-007**: 「要更新」の表示が視覚的に識別可能であること（ユーザビリティテストで90%以上のユーザーが正しく識別できること）

## UI要件

- **UI-001**: システムは「要更新」の表示を、契約一覧や従業員一覧で視覚的に目立つ形式（例：赤色のバッジ、警告アイコン、強調表示など）で行うこと
- **UI-002**: システムは「要更新」の表示がされている契約または従業員をクリックした場合、契約詳細画面または従業員詳細ページに遷移できること
- **UI-003**: システムは「要更新」の表示と同時に、契約満了予定日を表示すること（ユーザーがどの日付を基準に判定されているかを確認できるようにする）

## 前提条件

- 契約テーブルに雇用満了予定日（employment_expiry_scheduled_date）フィールドが存在すること（002-contract-expiry-dateで実装済み）
- ユーザーは適切なアクセス認証情報とロール割り当て（統括人事管理者、現場マネージャー、管理者）を持っていること
- システムは既存の契約管理機能と従業員管理機能が動作していること

## 依存関係

- 既存の契約管理機能（001-employee-db-requirements）
- 契約テーブルの雇用満了日管理機能（002-contract-expiry-date）
- 従業員管理機能（001-employee-db-requirements）

## 対象外

- 契約満了予定日が近づいている（まだ過ぎていない）契約への警告表示（本機能は「過ぎている」契約のみを対象）
- 契約更新の自動化機能（表示のみで、更新手続きは手動）
- 「要更新」表示の通知機能（画面表示のみで、メール通知などは対象外）
- 契約満了予定日の自動計算機能（既存の手動入力方式を維持）

