# Feature Specification: 契約管理画面の操作メニュー機能と契約履歴管理

**Feature Branch**: `006-contract-actions`  
**Created**: 2025-11-19  
**Status**: Draft  
**Input**: User description: "契約管理画面の一覧表示のアラート列の右側に操作列を追加してください。操作列には3点メニューを設置し、ポップアップで契約プレビュー、契約更新、新規契約作成、契約の削除の４つのメニューが表示されるようにします。契約の新規作成及び更新画面では、ワークコンディションテーブルやコントラクトテーブルの情報を入力表示できるようにします。新しい契約が作成されたり、契約が更新された場合は、employment_historyテーブルに新しい契約番号を付与して、契約内容を追記します。従業員管理画面には新しい契約を登録しても、雇用期間の開始日時になるまでは現行の勤務情報、給与、手当情報、書類情報を表示させるようにします。新しい契約の雇用期間の開始日を超えた場合は、新しい契約内容を従業員管理詳細ページの勤務情報、給与・手当、書類、備考のそれぞれのタブに反映させるようにします。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 契約管理画面の操作メニュー (Priority: P1)

統括人事管理者が契約管理画面の一覧表示で、各契約の操作列にある3点メニューをクリックし、契約プレビュー、契約更新、新規契約作成、契約削除の4つの操作を選択できる。

**Why this priority**: 契約管理画面は契約を管理する主要な画面であり、契約に対する操作を効率的に実行できることが重要です。3点メニューにより、画面をすっきり保ちながら、必要な操作に素早くアクセスできます。

**Independent Test**: 統括人事管理者が契約管理画面を表示し、3点メニューをクリックして4つの操作メニューが表示されることを確認します。各メニュー項目を選択して、適切な画面やアクションに遷移できることを検証できます。

**Acceptance Scenarios**:

1. **Given** 統括人事管理者が契約管理画面の一覧を表示している, **When** アラート列の右側に操作列が表示されていることを確認する, **Then** 各契約行に3点メニューアイコンが表示される
2. **Given** 統括人事管理者が契約管理画面の一覧を表示している, **When** 3点メニューアイコンをクリックする, **Then** ポップアップメニューが表示され、「契約プレビュー」「契約更新」「新規契約作成」「契約削除」の4つのメニュー項目が表示される
3. **Given** 統括人事管理者が3点メニューから「契約プレビュー」を選択する, **When** メニュー項目をクリックする, **Then** 契約のプレビュー画面が表示される
4. **Given** 統括人事管理者が3点メニューから「契約更新」を選択する, **When** メニュー項目をクリックする, **Then** 契約更新画面が表示される
5. **Given** 統括人事管理者が3点メニューから「新規契約作成」を選択する, **When** メニュー項目をクリックする, **Then** 新規契約作成画面が表示される
6. **Given** 統括人事管理者が3点メニューから「契約削除」を選択する, **When** メニュー項目をクリックし、削除確認ダイアログで確認する, **Then** 契約が削除される

---

### User Story 2 - 契約作成・更新画面での情報入力 (Priority: P1)

統括人事管理者が契約の新規作成または更新画面で、work_conditionsテーブルとcontractsテーブルの情報を入力・表示できる。

**Why this priority**: 契約作成・更新時に必要な情報を一括で入力できることが重要です。work_conditionsとcontractsの情報を同じ画面で入力することで、作業効率が向上し、データの整合性も保たれます。

**Independent Test**: 統括人事管理者が新規契約作成画面を表示し、contractsテーブルの情報（契約種別、契約期間、時給など）とwork_conditionsテーブルの情報（勤務時間、休憩時間、勤務場所、交通費など）を入力できることを確認します。既存の契約を更新する場合も、同様に両方のテーブルの情報を編集できることを検証できます。

**Acceptance Scenarios**:

1. **Given** 統括人事管理者が新規契約作成画面を表示している, **When** contractsテーブルの情報（契約種別、契約開始日、雇用満了予定日、時給、残業時給など）を入力する, **Then** 入力した情報が正しく保存される
2. **Given** 統括人事管理者が新規契約作成画面を表示している, **When** work_conditionsテーブルの情報（勤務時間帯、休憩時間帯、勤務場所、交通費情報など）を入力する, **Then** 入力した情報が正しく保存される
3. **Given** 統括人事管理者が契約更新画面を表示している, **When** 既存のcontractsテーブルとwork_conditionsテーブルの情報が表示されることを確認する, **Then** 両方のテーブルの情報が正しく表示される
4. **Given** 統括人事管理者が契約更新画面で情報を変更する, **When** 変更内容を保存する, **Then** 変更した情報が正しく保存される

---

### User Story 3 - 契約履歴への自動追記 (Priority: P1)

新しい契約が作成されたり、契約が更新された場合、employment_historyテーブルに新しい契約番号を付与して、契約内容が自動的に追記される。

**Why this priority**: 契約の変更履歴を正確に記録することは、監査や法的要件の遵守のために重要です。契約の作成・更新時に自動的に履歴が記録されることで、手動での記録漏れを防ぎます。

**Independent Test**: 統括人事管理者が新規契約を作成し、保存した後、employment_historyテーブルに新しいレコードが作成され、契約番号と契約内容が記録されることを確認します。契約を更新した場合も、同様に履歴が追記されることを検証できます。

**Acceptance Scenarios**:

1. **Given** 統括人事管理者が新規契約を作成する, **When** 契約情報を入力して保存する, **Then** employment_historyテーブルに新しいレコードが作成され、契約番号（contracts.id）と契約内容が記録される
2. **Given** 統括人事管理者が既存の契約を更新する, **When** 契約情報を変更して保存する, **Then** employment_historyテーブルに新しいレコードが作成され、更新後の契約番号と契約内容が記録される
3. **Given** 統括人事管理者が従業員の契約履歴を表示する, **When** 契約履歴タブを確認する, **Then** 新規作成・更新された契約の情報が時系列で表示される

---

### User Story 4 - 従業員管理画面での契約情報の表示制御 (Priority: P1)

統括人事管理者または現場マネージャーが従業員管理画面を表示した際、新しい契約の雇用期間開始日時になるまでは現行の勤務情報、給与・手当情報、書類情報が表示され、雇用期間開始日を超えた場合は新しい契約内容が反映される。

**Why this priority**: 従業員管理画面で表示される情報の正確性は重要です。契約の開始日時を基準に情報を切り替えることで、ユーザーは常に有効な契約情報を確認できます。

**Independent Test**: 統括人事管理者が従業員管理画面を表示し、新しい契約が登録されているが雇用期間開始日時が未来の場合、現行の契約情報が表示されることを確認します。雇用期間開始日を過ぎた後、新しい契約内容が表示されることを検証できます。

**Acceptance Scenarios**:

1. **Given** 従業員に新しい契約が登録されているが、雇用期間開始日（contract_start_date）が未来の日付である, **When** 統括人事管理者が従業員管理画面の詳細ページを表示する, **Then** 勤務情報、給与・手当、書類、備考の各タブに現行の契約情報が表示される
2. **Given** 従業員に新しい契約が登録されており、雇用期間開始日（contract_start_date）が当日または過去の日付である, **When** 統括人事管理者が従業員管理画面の詳細ページを表示する, **Then** 勤務情報、給与・手当、書類、備考の各タブに新しい契約の情報が表示される
3. **Given** 従業員に複数の契約が登録されている, **When** 統括人事管理者が従業員管理画面の詳細ページを表示する, **Then** 現在有効な契約（雇用期間開始日が当日または過去で、最も新しい契約）の情報が表示される
4. **Given** 従業員に有効な契約が存在しない, **When** 統括人事管理者が従業員管理画面の詳細ページを表示する, **Then** 勤務情報、給与・手当、書類、備考の各タブに「契約情報なし」または空の状態が表示される

---

### Edge Cases

- 契約削除時に、既に雇用期間開始日を過ぎている契約を削除しようとした場合、警告メッセージを表示し、削除を確認する
- 複数の契約が同じ雇用期間開始日を持つ場合、契約作成日時が新しい契約を優先して表示する
- 契約更新時に、既存のwork_conditionsレコードを更新するか、新しいレコードを作成するかの判断（有効期間による判定）
- 従業員管理画面で、契約情報が存在しない場合の表示（空の状態または「契約情報なし」メッセージ）
- 契約プレビュー画面で、PDF形式での表示または印刷機能の提供
- 契約削除時に、関連するemployment_historyレコードの扱い（削除するか、履歴として保持するか）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは契約管理画面の一覧表示で、アラート列の右側に操作列を追加し、各契約行に3点メニューアイコンを表示すること。
- **FR-002**: システムは3点メニューアイコンをクリックした際、ポップアップメニューを表示し、「契約プレビュー」「契約更新」「新規契約作成」「契約削除」の4つのメニュー項目を表示すること。
- **FR-003**: システムは「契約プレビュー」メニューを選択した際、契約のプレビュー画面を表示すること。
- **FR-004**: システムは「契約更新」メニューを選択した際、契約更新画面を表示すること。
- **FR-005**: システムは「新規契約作成」メニューを選択した際、新規契約作成画面を表示すること。
- **FR-006**: システムは「契約削除」メニューを選択した際、削除確認ダイアログを表示し、確認後に契約を削除すること。
- **FR-007**: システムは契約の新規作成・更新画面で、contractsテーブルの情報（契約種別、契約開始日、雇用満了予定日、時給、残業時給、業務内容、有給休暇条項など）を入力・表示できること。
- **FR-008**: システムは契約の新規作成・更新画面で、work_conditionsテーブルの情報（勤務時間帯、休憩時間帯、勤務場所、交通費情報、勤務日数タイプ、勤務日数など）を入力・表示できること。
- **FR-009**: システムは新しい契約が作成された場合、employment_historyテーブルに新しいレコードを作成し、契約番号（contracts.id）と契約内容を記録すること。
- **FR-010**: システムは契約が更新された場合、employment_historyテーブルに新しいレコードを作成し、更新後の契約番号（contracts.id）と契約内容を記録すること。
- **FR-011**: システムは従業員管理画面の詳細ページで、新しい契約の雇用期間開始日（contract_start_date）が当日または過去の日付である場合、新しい契約の情報を表示すること。
- **FR-012**: システムは従業員管理画面の詳細ページで、新しい契約の雇用期間開始日（contract_start_date）が未来の日付である場合、現行の契約情報を表示すること。
- **FR-013**: システムは従業員管理画面の詳細ページで、複数の契約が存在する場合、現在有効な契約（雇用期間開始日が当日または過去で、最も新しい契約）の情報を表示すること。
- **FR-014**: システムは従業員管理画面の詳細ページの勤務情報タブで、有効な契約のwork_conditions情報を表示すること。
- **FR-015**: システムは従業員管理画面の詳細ページの給与・手当タブで、有効な契約のcontracts情報（時給、残業時給など）とwork_conditions情報（交通費など）を表示すること。
- **FR-016**: システムは従業員管理画面の詳細ページの書類タブで、有効な契約に関連する書類情報を表示すること。
- **FR-017**: システムは従業員管理画面の詳細ページの備考タブで、有効な契約に関連する備考情報を表示すること。

### Key Entities *(include if feature involves data)*

- **契約（Contract）**: 雇用契約を表し、以下の情報を含む：
  - 契約種別（INDEFINITE/FIXED_TERM）
  - 契約開始日（contract_start_date）
  - 雇用満了予定日（employment_expiry_scheduled_date）
  - 時給（hourly_wage）
  - 残業時給（overtime_hourly_wage）
  - 業務内容（job_description）
  - 有給休暇条項（paid_leave_clause）
  - その他の契約情報
- **勤務条件（Work Condition）**: 勤務条件を表し、以下の情報を含む：
  - 勤務時間帯（working_hours_jsonb）
  - 休憩時間帯（break_hours_jsonb）
  - 勤務場所（work_locations_jsonb）
  - 交通費情報（transportation_routes_jsonb）
  - 勤務日数タイプ（work_days_type）
  - 勤務日数（work_days_count）
  - 有効期間（effective_from, effective_to）
- **雇用履歴（Employment History）**: 雇用・人事履歴を表し、以下の情報を含む：
  - 契約番号（contracts.idへの参照）
  - 有効日（effective_date）
  - イベント種別（event_type）
  - 契約内容の記録
  - その他の履歴情報

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 統括人事管理者が契約管理画面の一覧で、3点メニューをクリックしてから操作メニューが表示されるまでの時間が1秒以内であること
- **SC-002**: 統括人事管理者が契約の新規作成・更新画面で、contractsテーブルとwork_conditionsテーブルの情報を入力して保存できること（100%の成功率）
- **SC-003**: 新しい契約が作成された場合、employment_historyテーブルに契約番号と契約内容が100%の精度で記録されること
- **SC-004**: 契約が更新された場合、employment_historyテーブルに更新後の契約番号と契約内容が100%の精度で記録されること
- **SC-005**: 従業員管理画面の詳細ページで、有効な契約の情報が100%の精度で表示されること（雇用期間開始日による判定が正しく動作すること）
- **SC-006**: 統括人事管理者が契約の新規作成から保存までを5分以内に完了できること
- **SC-007**: 統括人事管理者が契約の更新から保存までを3分以内に完了できること
- **SC-008**: 従業員管理画面の詳細ページで、契約情報の表示切り替え（現行契約から新規契約への切り替え）が即座に反映されること（画面再読み込み不要）

## UI要件

- **UI-001**: システムは契約管理画面の一覧表示で、操作列をアラート列の右側に配置し、3点メニューアイコンを視覚的に識別しやすい形式で表示すること。
- **UI-002**: システムは3点メニューのポップアップを、クリックした位置の近くに表示し、メニュー項目を明確に区別できる形式で表示すること。
- **UI-003**: システムは契約の新規作成・更新画面で、contractsテーブルとwork_conditionsテーブルの情報を、論理的にグループ化して表示し、入力しやすい形式で提供すること。
- **UI-004**: システムは契約削除時に、削除確認ダイアログを表示し、削除の影響（関連する履歴やデータへの影響）を明確に示すこと。
- **UI-005**: システムは従業員管理画面の詳細ページで、有効な契約の情報がどの契約に基づいているかを明確に表示すること（契約番号や契約期間の表示）。

## 前提条件

- 契約管理画面が既に存在し、一覧表示機能が動作していること
- contractsテーブルとwork_conditionsテーブルが存在し、適切なスキーマ定義がされていること
- employment_historyテーブルが存在し、契約番号を記録できる構造になっていること
- 従業員管理画面の詳細ページが既に存在し、勤務情報、給与・手当、書類、備考の各タブが実装されていること
- ユーザーは適切なアクセス認証情報とロール割り当て（統括人事管理者、現場マネージャー、管理者）を持っていること

## 依存関係

- 既存の契約管理機能（001-employee-db-requirements）
- 契約テーブルの雇用満了日管理機能（002-contract-expiry-date）
- 従業員管理機能（001-employee-db-requirements）
- 勤務条件管理機能（001-employee-db-requirements）

## 対象外

- 契約プレビュー画面でのPDF出力機能（既存のPDF出力機能を利用）
- 契約削除時の関連データの自動削除（履歴は保持）
- 契約の一括操作機能（個別操作のみ）
- 契約の承認ワークフロー（承認機能は対象外）

