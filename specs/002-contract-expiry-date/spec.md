# Feature Specification: 契約テーブルの雇用満了日管理機能

**Feature Branch**: `002-contract-expiry-date`  
**Created**: 2025-01-28  
**Status**: Draft  
**Input**: User description: "contracts テーブルに「雇用満了日」を設定してください。contract_start_data と 「雇用満了予定日」で雇用期間を管理するように仕様を変更してください。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 雇用期間の管理と表示 (Priority: P1)

統括人事管理者が契約の雇用期間を、契約開始日と雇用満了予定日で管理し、実際の雇用満了日を記録できる。

**Why this priority**: 雇用期間の正確な管理は契約管理の基盤であり、契約更新アラートや給与計算などの他の機能が正しく動作するために必須です。予定日と実際の満了日を区別することで、契約延長や早期終了の状況を正確に把握できます。

**Independent Test**: 統括人事管理者が契約を作成し、雇用満了予定日を設定し、後で実際の雇用満了日を記録できることを確認します。雇用期間が正しく表示され、契約更新アラートが適切に動作することを検証できます。

**Acceptance Scenarios**:

1. **Given** 統括人事管理者が新規契約を作成する, **When** 契約開始日と雇用満了予定日を入力して保存する, **Then** 契約が正しく登録され、雇用期間（契約開始日〜雇用満了予定日）が表示される
2. **Given** 契約が登録されている, **When** 実際の雇用満了日を入力する, **Then** 雇用満了日が記録され、雇用期間の表示が更新される
3. **Given** 契約が登録されている, **When** 雇用満了予定日を変更する, **Then** 変更が保存され、契約更新アラートが新しい予定日に基づいて再計算される
4. **Given** 複数の契約が登録されている, **When** 雇用期間で検索・フィルタリングする, **Then** 契約開始日と雇用満了予定日に基づいて正しくフィルタリングされる

---

### User Story 2 - 契約更新アラートの正確な動作 (Priority: P1)

契約更新アラートが雇用満了予定日に基づいて正確に送信される。

**Why this priority**: 契約更新の見逃しを防ぐため、アラート機能が正しい日付に基づいて動作することが重要です。雇用満了予定日と実際の満了日を区別することで、予定日ベースのアラートが正確に機能します。

**Independent Test**: 雇用満了予定日が30日前、14日前、7日前になった契約に対して、アラートが正しく送信されることを確認します。実際の雇用満了日が設定されていても、予定日ベースでアラートが動作することを検証できます。

**Acceptance Scenarios**:

1. **Given** 雇用満了予定日が30日前になった契約がある, **When** アラートシステムが動作する, **Then** 統括人事管理者と現場マネージャーに通知が送られる
2. **Given** 雇用満了予定日が設定されている契約がある, **When** 実際の雇用満了日を設定する, **Then** 予定日ベースのアラートは継続して動作し、実際の満了日は記録のみに使用される
3. **Given** 雇用満了予定日を変更する, **When** 変更を保存する, **Then** アラートが新しい予定日に基づいて再計算される

---

### User Story 3 - 契約履歴の正確な表示 (Priority: P2)

従業員の契約履歴で、契約開始日、雇用満了予定日、実際の雇用満了日が正確に表示される。

**Why this priority**: 過去の契約情報を正確に参照するため、予定日と実際の満了日を区別して表示することが重要です。ただし、基本機能が動作した後に実装することで、段階的に価値を提供できます。

**Independent Test**: 統括人事管理者が従業員の契約履歴を表示し、各契約の契約開始日、雇用満了予定日、実際の雇用満了日が正しく表示されることを確認します。

**Acceptance Scenarios**:

1. **Given** 従業員に複数の契約履歴がある, **When** 契約履歴を表示する, **Then** 各契約の契約開始日、雇用満了予定日、実際の雇用満了日が時系列で表示される
2. **Given** 契約に実際の雇用満了日が設定されていない, **When** 契約履歴を表示する, **Then** 雇用満了予定日のみが表示され、実際の満了日は「未設定」または空白として表示される

---

### Edge Cases

- 雇用満了予定日が設定されていない契約の場合、雇用期間は契約開始日のみで表示される
- 実際の雇用満了日が雇用満了予定日より前の場合（早期終了）、両方の日付が記録される
- 実際の雇用満了日が雇用満了予定日より後の場合（延長）、両方の日付が記録される
- 契約更新時に、既存の契約の実際の雇用満了日が新しい契約の契約開始日と一致する必要がある
- 雇用満了予定日を過去の日付に設定しようとした場合、バリデーションエラーが表示される
- 実際の雇用満了日を契約開始日より前の日付に設定しようとした場合、バリデーションエラーが表示される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは契約（Contract）エンティティに「雇用満了予定日」（employment_expiry_scheduled_date）フィールドを追加すること。このフィールドは契約開始日（contract_start_date）と組み合わせて雇用期間を管理するために使用される。
- **FR-002**: システムは契約（Contract）エンティティに「雇用満了日」（employment_expiry_date）フィールドを追加すること。このフィールドは実際の雇用終了日を記録するために使用され、任意項目とする。
- **FR-003**: システムは雇用期間を「契約開始日〜雇用満了予定日」として表示すること。実際の雇用満了日が設定されている場合、それも併せて表示すること。
- **FR-004**: システムは契約更新アラートを雇用満了予定日に基づいて送信すること。実際の雇用満了日が設定されていても、予定日ベースでアラートが動作すること。
- **FR-005**: システムは雇用満了予定日が契約開始日より後の日付であることを検証すること。
- **FR-006**: システムは実際の雇用満了日が契約開始日より後の日付であることを検証すること（設定されている場合）。
- **FR-007**: システムは契約履歴表示で、契約開始日、雇用満了予定日、実際の雇用満了日を表示すること。
- **FR-008**: システムは雇用満了予定日を変更した場合、契約更新アラートを再計算すること。
- **FR-009**: システムは既存の契約終了日（contract_end_date）フィールドを雇用満了予定日（employment_expiry_scheduled_date）に移行すること。既存データの移行が必要な場合、contract_end_dateの値をemployment_expiry_scheduled_dateにコピーすること。

### Key Entities *(include if feature involves data)*

- **契約（Contract）**: 雇用契約を表し、以下の日付フィールドを含む：
  - `contract_start_date` (DATE NOT NULL): 契約開始日
  - `employment_expiry_scheduled_date` (DATE): 雇用満了予定日（契約時に設定する予定の満了日）
  - `employment_expiry_date` (DATE): 雇用満了日（実際の雇用終了日、任意項目）
  - その他の既存フィールド（契約種別、業務内容、時給、残業時給、有給休暇条項、雇用終了アラートフラグなど）は変更なし
  - 注記: 既存の`contract_end_date`フィールドは`employment_expiry_scheduled_date`に置き換えられる

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 統括人事管理者が契約を作成し、契約開始日と雇用満了予定日を設定して保存できること（100%の成功率）
- **SC-002**: 契約更新アラートが雇用満了予定日に基づいて100%の精度で送信されること（予定日の30日前、14日前、7日前）
- **SC-003**: 雇用期間の表示が「契約開始日〜雇用満了予定日」として正確に表示されること（100%の精度）
- **SC-004**: 実際の雇用満了日を設定した場合、その日付が正しく記録され、表示されること（100%の精度）
- **SC-005**: 既存の契約データ（contract_end_date）が新しいフィールド（employment_expiry_scheduled_date）に正しく移行されること（データ損失ゼロ）
- **SC-006**: 雇用満了予定日を過去の日付に設定しようとした場合、バリデーションエラーが表示されること（100%の精度）
- **SC-007**: 契約履歴表示で、契約開始日、雇用満了予定日、実際の雇用満了日が正しく表示されること（100%の精度）

## UI要件

- **UI-001**: システムは契約登録・編集フォームで契約開始日と雇用満了予定日を近い場所に表示し、使いやすさを向上させること
- **UI-002**: システムは実際の雇用満了日を別のセクションまたはフィールドとして表示し、予定日と区別できるようにすること

## 前提条件

- 既存の契約データ（contract_end_date）が存在する場合、移行処理が必要
- ユーザーは適切なアクセス認証情報とロール割り当て（統括人事管理者、現場マネージャー、管理者）を持っていること
- システムは既存の契約管理機能が動作していること

## 依存関係

- 既存の契約管理機能（001-employee-db-requirements）
- 契約更新アラート機能（FR-010）
- 契約履歴表示機能（FR-022）

## 対象外

- 契約終了日（contract_end_date）フィールドの即座の削除（後方互換性のため、段階的な移行を想定）
- 雇用満了予定日の自動計算機能（手動入力のみ）
- 複数の雇用満了予定日の管理（1契約あたり1つの予定日）
