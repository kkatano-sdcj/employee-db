# Feature Specification: 勤務条件テーブルの統合

**Feature Branch**: `003-work-conditions-consolidation`  
**Created**: 2025-01-28  
**Status**: Draft  
**Input**: User description: "3. working_hours テーブル（勤務時間帯）と4. break_hours テーブル（休憩時間帯）と5. work_locations テーブル（勤務場所）と 6. transportation_routes テーブル（交通費情報）を 2. work_conditions テーブル（勤務条件）統合するように仕様を変更してください。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 勤務条件の登録と管理 (Priority: P1)

統括人事管理者が勤務条件を登録・編集する際、勤務時間帯、休憩時間帯、勤務場所、交通費情報を1つのレコードで管理できる。

**Why this priority**: 勤務条件の管理を簡素化し、データの整合性を向上させる基盤機能です。複数のテーブルに分散していた情報を1つのテーブルに統合することで、データの取得と更新が効率化され、トランザクション処理が簡潔になります。

**Independent Test**: 統括人事管理者が勤務条件を登録し、複数の勤務時間帯、休憩時間帯、勤務場所、交通費情報を1つの操作で保存できることを確認します。登録された情報が正しく表示され、編集・削除が正常に動作することを検証できます。

**Acceptance Scenarios**:

1. **Given** 統括人事管理者が新規勤務条件を登録する, **When** 複数の勤務時間帯、休憩時間帯、勤務場所、交通費情報を入力して保存する, **Then** すべての情報が1つのレコードとして正しく登録され、表示される
2. **Given** 勤務条件が登録されている, **When** 勤務時間帯を追加・削除・変更する, **Then** 変更が正しく保存され、他の情報（休憩時間帯、勤務場所、交通費）に影響しない
3. **Given** 勤務条件が登録されている, **When** 交通費情報を更新する, **Then** 更新が正しく保存され、他の情報に影響しない
4. **Given** 複数の勤務条件が登録されている, **When** 勤務条件を検索・フィルタリングする, **Then** 統合された構造でも正しく検索・フィルタリングされる

---

### User Story 2 - 統合構造としての管理 (Priority: P1)

既存の分散テーブル構造（working_hours、break_hours、work_locations、transportation_routes）のデータをJSONBカラムに移行し、物理的に統合構造として管理できる。

**Why this priority**: 既存データを失うことなく、統合構造として管理することが必須です。JSONBカラムへの物理的な統合により、データの取得と更新が効率化され、トランザクション処理が簡潔になります。

**Independent Test**: 既存の分散テーブル構造のデータをJSONBカラムに移行し、すべてのデータが正しく取得・表示され、データ損失がないことを確認します。統合構造として管理しても既存の機能が正常に動作することを検証できます。

**Acceptance Scenarios**:

1. **Given** 既存の分散テーブル構造にデータが存在する, **When** データをJSONBカラムに移行する, **Then** すべてのデータが正しく移行され、データ損失がない
2. **Given** 統合構造として管理されている, **When** データを表示する, **Then** すべての情報（勤務時間帯、休憩時間帯、勤務場所、交通費）が正しく表示される
3. **Given** 統合構造として管理されている, **When** 既存の機能（検索、編集、削除）を使用する, **Then** すべての機能が正常に動作する
4. **Given** データ移行が完了した, **When** 子テーブルを削除する, **Then** 統合構造のみで正常に動作する

---

### User Story 3 - データ整合性の維持 (Priority: P2)

統合後の構造でも、複数の勤務時間帯、休憩時間帯、勤務場所、交通費情報を正しく管理できる。

**Why this priority**: 統合後も、1つの勤務条件に対して複数の値（複数の勤務時間帯など）を管理できることが重要です。ただし、基本機能が動作した後に検証することで、段階的に価値を提供できます。

**Independent Test**: 統合構造で複数の勤務時間帯、休憩時間帯、勤務場所、交通費情報を登録し、すべてが正しく保存・表示されることを確認します。

**Acceptance Scenarios**:

1. **Given** 統合構造で勤務条件を登録する, **When** 3つの勤務時間帯、2つの休憩時間帯、2つの勤務場所、2つの交通費ルートを入力する, **Then** すべての情報が正しく保存され、表示される
2. **Given** 複数の値が登録されている勤務条件がある, **When** 1つの勤務時間帯を削除する, **Then** 削除が正しく反映され、他の情報に影響しない
3. **Given** 複数の値が登録されている勤務条件がある, **When** 交通費情報を1つ追加する, **Then** 追加が正しく反映され、既存の情報が保持される

---

### Edge Cases

- 勤務時間帯が0件の場合、バリデーションエラーが表示される（少なくとも1つの勤務時間帯が必要）
- 休憩時間帯が0件の場合でも、勤務条件は登録可能（休憩時間帯は任意項目）
- 勤務場所が0件の場合、バリデーションエラーが表示される（少なくとも1つの勤務場所が必要）
- 交通費情報が0件の場合でも、勤務条件は登録可能（交通費情報は任意項目）
- 勤務時間帯の時間が重複している場合、バリデーションエラーが表示される
- 休憩時間帯が勤務時間帯の範囲外の場合、バリデーションエラーが表示される
- JSONBカラムが空配列の場合、空のリストとして扱われる
- 統合構造へのアクセス時にエラーが発生した場合、適切なエラーメッセージが表示される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは勤務条件（Work Condition）エンティティに、複数の勤務時間帯、休憩時間帯、勤務場所、交通費情報を統合された構造で保存できること。`work_conditions`テーブルにJSONBカラム（`working_hours_jsonb`、`break_hours_jsonb`、`work_locations_jsonb`、`transportation_routes_jsonb`）を追加し、物理的に1つのテーブルに統合すること。
- **FR-002**: システムは統合構造でも、1つの勤務条件に対して複数の勤務時間帯を設定できること。各勤務時間帯は開始時刻と終了時刻を含むこと。
- **FR-003**: システムは統合構造でも、1つの勤務条件に対して複数の休憩時間帯を設定できること。各休憩時間帯は開始時刻と終了時刻を含むこと。休憩時間帯は任意項目とすること。
- **FR-004**: システムは統合構造でも、1つの勤務条件に対して複数の勤務場所を設定できること。各勤務場所は場所名を含むこと。
- **FR-005**: システムは統合構造でも、1つの勤務条件に対して複数の交通費情報を設定できること。各交通費情報はルート名、往復金額、月額定期、上限金額、最寄り駅を含むこと。交通費情報は任意項目とすること。
- **FR-006**: システムは既存の分散テーブル構造（working_hours、break_hours、work_locations、transportation_routes）のデータをJSONBカラムに移行し、物理的に統合構造として管理できること。既存データをJSONBカラムに移行し、データ損失がないことを確認すること。移行後は子テーブルを削除すること。
- **FR-007**: システムは統合構造でも、勤務時間帯の重複を検証すること。同じ勤務条件内で、勤務時間帯が重複している場合、バリデーションエラーを表示すること。
- **FR-008**: システムは統合構造でも、休憩時間帯が勤務時間帯の範囲内であることを検証すること。範囲外の休憩時間帯が設定されている場合、バリデーションエラーを表示すること。
- **FR-009**: システムは統合構造でも、少なくとも1つの勤務時間帯と1つの勤務場所が設定されていることを検証すること。これらが設定されていない場合、バリデーションエラーを表示すること。
- **FR-010**: システムは統合構造でも、既存の機能（検索、編集、削除、表示）が正常に動作すること。統合前と同等の機能を提供すること。
- **FR-011**: システムは統合構造でも、勤務条件の有効期間（effective_from、effective_to）による絞り込みが正常に動作すること。
- **FR-012**: システムは統合構造でも、従業員IDによる勤務条件の取得が正常に動作すること。

### Key Entities *(include if feature involves data)*

- **勤務条件（Work Condition）**: 包括的な勤務設定を表し、以下の情報を統合された構造で含む：
  - 基本情報: 従業員ID、有効期間（開始日・終了日）、勤務日数タイプ、勤務日数、勤務日数備考、有給休暇付与基準日（work_conditionsテーブルに格納）
  - 勤務時間帯（複数）: 各勤務時間帯は開始時刻と終了時刻を含む（`work_conditions.working_hours_jsonb` JSONBカラムに配列形式で格納: `[{id, start_time, end_time}, ...]`）
  - 休憩時間帯（複数、任意）: 各休憩時間帯は開始時刻と終了時刻を含む（`work_conditions.break_hours_jsonb` JSONBカラムに配列形式で格納: `[{id, start_time, end_time}, ...]`）
  - 勤務場所（複数）: 各勤務場所は場所名を含む（`work_conditions.work_locations_jsonb` JSONBカラムに配列形式で格納: `[{id, location}, ...]`）
  - 交通費情報（複数、任意）: 各交通費情報はルート名、往復金額、月額定期、上限金額、最寄り駅を含む（`work_conditions.transportation_routes_jsonb` JSONBカラムに配列形式で格納: `[{id, route, round_trip_amount, monthly_pass_amount, max_amount, nearest_station}, ...]`）
  - 最終更新日時と更新者情報を含む
  - 注記: 物理的には`work_conditions`テーブル1つに統合され、JSONBカラムで複数の値を配列形式で管理する。既存の子テーブル（working_hours、break_hours、work_locations、transportation_routes）はデータ移行後に削除される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 統括人事管理者が勤務条件を登録し、複数の勤務時間帯、休憩時間帯、勤務場所、交通費情報を1つの操作で保存できること（100%の成功率）
- **SC-002**: 既存の分散テーブル構造のデータがJSONBカラムに正しく移行され、統合構造として正しく管理されること（データ損失ゼロ）
- **SC-003**: 統合構造でも、1つの勤務条件に対して複数の勤務時間帯（最大10件）を設定できること（100%の精度）
- **SC-004**: 統合構造でも、1つの勤務条件に対して複数の勤務場所（最大10件）を設定できること（100%の精度）
- **SC-005**: 統合構造でも、1つの勤務条件に対して複数の交通費情報（最大10件）を設定できること（100%の精度）
- **SC-006**: 統合構造でも、既存の機能（検索、編集、削除、表示）が正常に動作すること（統合前と同等の機能）
- **SC-007**: 統合構造でも、勤務時間帯の重複検証が100%の精度で動作すること
- **SC-008**: 統合構造でも、休憩時間帯が勤務時間帯の範囲内であることを100%の精度で検証すること
- **SC-009**: 統合構造としての管理が100%の成功率で動作すること（既存データのJSONBカラムへの移行が正常に完了すること）

## UI要件

- **UI-001**: システムは勤務条件登録・編集フォームで、勤務時間帯、休憩時間帯、勤務場所、交通費情報を統合されたUIで表示・編集できること
- **UI-002**: システムは複数の値を追加・削除・編集する操作を直感的に行えること（動的な追加・削除ボタンなど）

## 明確化事項

### Session 2025-01-28

- Q: 統合構造のデータ形式 → A: JSONBカラムを使用した物理的な統合（work_conditionsテーブルにJSONBカラムを追加し、子テーブルを削除）

## 前提条件

- 既存の分散テーブル構造（working_hours、break_hours、work_locations、transportation_routes）にデータが存在する場合、マイグレーションでJSONBカラムに移行される
- ユーザーは適切なアクセス認証情報とロール割り当て（統括人事管理者、現場マネージャー、管理者）を持っていること
- システムは既存の勤務条件管理機能が動作していること
- PostgreSQLのJSONB型がサポートされていること

## 依存関係

- 既存の勤務条件管理機能（001-employee-db-requirements）
- データ移行処理の実行環境

## 対象外

- 統合構造以外のデータ形式への対応
- 既存データの自動バックアップ機能（手動バックアップを推奨）
- JSONBカラムの検索・フィルタリング機能の最適化（基本的なGINインデックスのみ提供）
