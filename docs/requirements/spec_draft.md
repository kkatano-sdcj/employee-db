# 従業員データベース仕様書（改訂版）

> 本ドキュメントは、発注責任者からの追加要望を反映した最新版です。

---

## 1. 目的・スコープ

### 何をする・何のために必要か
* **雇用契約書からの手入力作業の廃止**: 統括課で雇用契約書からパート一覧への手入力転記作業を自動化し、作業効率を向上させる
* **給与支払データ作成の効率化**: 時給等の情報を一覧からデータで簡単に抽出し、給与支払データのマスター作成における手入力作業を削減する

### 目的・成果物
* 目的（Why）: **パート従業員を中心とした従業員情報・契約・勤務条件管理の効率化と正確性向上、手作業の削減**
* 成果物（What）: **従業員マスター、従業員情報入力・表示画面、雇用契約書PDF出力、就業条件マスター、履歴管理、アクセス権管理、給与支払データ抽出機能、契約更新アラート機能**
* 対象拠点・組織範囲: **アウトソーシング事業部統括課**

## 2. ステークホルダー

* 発注側責任者: **アウトソーシング事業部統括課**
* 運用責任者: **アウトソーシング事業部統括課**
* 利用者ロール: **統括人事管理者、現場マネージャー、管理者、監査**

## 3. 用語定義

* 「勤務時間」：時刻帯（例: 09:00〜18:00）で管理。複数登録可。
* 「休憩時間」：時刻帯（例: 12:00〜13:00）で管理。
* 「勤務日数」：週単位だけでなく「月○日」「シフト」等の柔軟設定可。
* 「勤務場所」：複数登録可能。
* 「交通費」：ルート単位（電車・バス等）で往復金額・月額定期・上限金額を保持。
* 「有休基準日」：付与の基準日として入力可。
* 「雇用契約」：契約更新有無、有期契約の基準日、業務内容、部署（部門コード管理）を含む。
* 「契約履歴表示項目」：雇用期間、勤務時間、勤務日数、勤務場所、時給、雇用保険、社会保険。
* 「勤務条件」：勤務時間帯・休憩時間帯・勤務場所・交通費情報を含む総合的な勤務設定。
* 「提出物・預かり品」：従業員から提出された書類や会社が預かっている物品の管理。
* 「契約書」：１つの契約期間につき１枚作成。契約内容変更時は再作成が必要。
* 「承認番号」：各契約書に個別に付与される管理番号。契約書再作成時は新規入力が必要。
* 「ステータス」：現場作成中／事業部長押印待ち／総務提出済／本人返却済などの進捗管理を想定。
* 「社員番号-枝番」：雇用契約書ごとに出力枝番が付与される。

## 4. ユースケース（要件）

* UC-01: **従業員を登録する（勤務時間・休憩時間を時間帯で入力、複数対応）**
* UC-02: **異動/昇給/減給/兼務の履歴管理**
* UC-02-1: **提出物・預かり品の管理（提出状況・返却状況の追跡）**
* UC-03: **退職/復職の管理**
* UC-04: **個人情報の参照・更新の申請/承認（連絡先の扱いは権限依存）**
* UC-05: **契約更新/破棄、契約更新基準日・契約有効期限管理、雇用終了日アラート解除連動**
* UC-05-1: **契約更新アラート機能（契約期限前の自動通知、リマインダー設定）**
* UC-05-2: **契約内容更新履歴管理（更新者・最終更新日時・変更内容の記録）**
* UC-06: **従業員検索/一覧/エクスポート（勤務場所で検索可能、雇用形態除外）**
* UC-07: **稼働レポート/ダッシュボード（ステータス・進捗を含む）**
* UC-08: **監査ログ/アクセス権管理**
* UC-09: **雇用契約書PDF出力（枝番付き、ルート別交通費含む、承認番号管理）**
* UC-09-1: **契約書承認番号管理（契約書作成・再作成時の承認番号入力・更新）**
* UC-10: **指定日時点でのデータCSV抽出（抽出項目選択可能）**
* UC-11: **給与計算用CSV出力（時給、通勤費、社保フラグ、各種手当を含む給与支払データ抽出）**
* UC-12: **同時編集制御（最初のアクセス者以外は編集不可）**

## 5. データモデル（論理）

> **技術実装**: Supabase (PostgreSQL) + Prisma ORM を使用
> - リレーショナルデータベースによる参照整合性の保証
> - 外部キー制約による関連データの一貫性確保
> - トランザクション機能による複数テーブルの同時更新
> - 型安全なクエリによる開発効率の向上

### 主要エンティティ

* **Employee（従業員マスタ）**: 従業員番号、枝番、氏名、氏名カナ、性別、生年月日、国籍、入社日、退職日、雇用区分、在籍ステータス、所属部門コード、個人番号（権限制限表示）、最終更新日時、更新者
* **EmploymentHistory（雇用・人事履歴）**: 期間、所属、職位、等級、有給、給与（時給）参照、勤務場所履歴、勤務日数種別（週/月/シフト）、最終更新日時、更新者
* **Salary（給与情報）**: 時給（複数レート対応）、社会保険加入フラグ（0/1）、各種手当（基本手当、職務手当、皆勤手当、その他手当）、適用期間、最終更新日時、更新者
* **WorkCondition（勤務条件）**: 勤務時間帯（複数可・正規化テーブルで管理）、休憩時間帯（複数可・正規化テーブルで管理）、勤務場所（複数可・正規化テーブルで管理）、有休付与基準日、交通費情報（ルート別、往復金額、月額定期、上限金額・正規化テーブルで管理）、最終更新日時、更新者
  - 関連テーブル: WorkingHours（勤務時間帯）、BreakHours（休憩時間帯）、WorkLocation（勤務場所）、TransportationRoute（交通費）
* **Contract（契約）**: 契約種別、契約期間（開始・終了）、契約更新有無、有期契約基準日、業務内容、雇用終了アラートフラグ、最終更新日時、更新者
* **ContractAlert（契約更新アラート）**: 契約ID参照、アラート種別（更新期限前通知、雇用終了通知）、通知日時、通知対象者、アラート状態（未通知/通知済/確認済）、最終更新日時
* **ContractChangeHistory（契約変更履歴）**: 契約ID参照、変更日時、変更項目、変更前値、変更後値、変更理由、更新者、変更承認者
* **ContractHistoryView（契約履歴表示）**: 雇用期間、勤務時間、勤務日数、勤務場所、時給、雇用保険、社会保険（表示専用ビュー）
* **DocumentSubmission（提出物・預かり品）**: 従業員ID参照、文書種別（提出物/預かり品）、文書名、提出日、返却予定日、返却日、状態（未提出/提出済/返却済）、備考、最終更新日時、更新者
* **Document（契約書文書）**: 契約書ID、承認番号、契約期間参照、文書種別、ステータス（現場作成中／事業部長押印待ち／総務提出済／本人返却済）、作成日時、承認日時、文書データ（PDF）、最終更新日時、更新者
* **User/Role/Permission（アクセス制御）**
* **EditLock（編集ロック）**: 対象レコードID、ロック取得者、ロック取得時刻、ロック有効期限

### データモデルの実装方針

* **正規化**: 複数値を持つ項目（勤務時間帯、休憩時間帯、勤務場所、交通費）は個別のテーブルに分割し、外部キーで関連付け
* **参照整合性**: 外部キー制約により、従業員削除時は関連データもカスケード削除（ON DELETE CASCADE）
* **トランザクション**: 勤務条件の保存時は、親レコード（WorkCondition）と子レコード（勤務時間帯等）を同一トランザクションで処理
* **インデックス**: 検索頻度の高い項目（従業員番号、部門コード、契約終了日等）にインデックスを設定
* **監査ログ**: 全ての変更操作を audit_logs テーブルに記録（変更前後の値をJSON形式で保存）

## 6. 画面/機能一覧（概要）

* **従業員情報登録/編集**（雇用期間の開始・終了を近接表示、最終更新日時表示）
* **勤務時間・休憩時間帯入力（複数対応・数値入力）**
* **勤務条件保存修正機能（バグ修正対象）**
* **勤務場所複数登録、部門コード管理**
* **雇用契約書作成・更新（枝番付与・契約更新有無・業務内容・承認番号管理）**
* **社員一覧検索（勤務場所フィルタ、ステータス表示、一覧一括更新）**
* **契約更新アラート機能（契約期限前通知、リマインダー設定、通知履歴管理）**
* **契約変更履歴管理（変更内容・更新者・承認者の記録・履歴表示）**
* **契約履歴表示（雇用期間・勤務時間・勤務日数・勤務場所・時給・雇用保険・社会保険）**
* **提出物・預かり品管理（提出状況・返却状況の追跡・一覧表示）**
* **雇用契約書PDF出力（枝番自動付与、ルート別交通費表示、承認番号表示）**
* **契約書承認番号管理（新規作成・再作成時の承認番号入力・履歴管理）**
* **給与計算用CSV出力機能（時給・通勤費・社保フラグ・各種手当を含む給与支払データ抽出）**
* **指定日時点データCSV抽出（抽出項目選択機能付き）**
* **同時編集制御（編集ロック機能、最初のアクセス者以外は編集不可）**
* **承認フロー（現場→統括→管理者）**
* **入力時の誤操作対策（Enterキーで保存されない仕様）**

## 7. 権限・認可ポリシー

### ロール別権限
* **統括人事管理者**：従業員情報全管理（編集権限）
* **現場マネージャー**：担当部署の勤務情報・勤務場所閲覧（参照権限のみ）
* **管理者**：全権
* **監査**：全社閲覧のみ

### アクセス制御詳細
* **列レベル制御**：個人番号、給与情報は統括/管理者のみ閲覧可
* **行レベル制御**：現場マネージャーは自部門・自拠点のみアクセス可能
* **編集制御**：複数人同時アクセス時は最初のアクセス者以外は編集不可
* **部署制限**：担当部署以外のデータは参照不可設定
* **機能別権限**：
  - CSV抽出：統括/管理者のみ
  - 契約書PDF出力：統括/管理者のみ
  - 給与計算用CSV出力：統括/管理者のみ

## 8. データライフサイクル/プライバシー

* 保持期間（在職/退職後）: **未定（将来法令基準に準拠）**
* 個人情報最小化方針：住所・電話番号等の個人連絡先情報は保持しない
* 銀行口座情報は**保持しない**
* データ更新履歴：最終更新日時・更新者を記録

## 9. 連携

* 現状：**外部連携なし**（将来拡張検討）

## 10. 非機能要求

### データベース・インフラ
* **データベース**: Supabase (PostgreSQL) を使用
* **ORM**: Prisma を使用し、型安全なデータアクセスを実現
* **マイグレーション**: Prisma Migrateによるバージョン管理されたスキーマ変更
* **バックアップ**: Supabaseの自動バックアップ機能を利用（ポイントインタイムリカバリ対応）

### 操作性・同時編集制御
* **Enterキー押下時は次フィールド移動、保存は明示的ボタンのみ**
* **同時編集制御**：複数人が同じレコードにアクセスした場合、最初のアクセス者以外は編集不可
  - 実装方式: edit_locks テーブルによる楽観的ロック
  - ロック有効期限: 15分（自動解放）
  - 開発環境での無効化: `NODE_ENV=development` または `SKIP_LOCK_CHECK=true` の場合はロック機能を無効化
* **最終更新日時表示**：全ての画面で最終更新日時を表示

### アラート・通知機能
* **契約更新アラート**：契約期限の30日前、14日前、7日前に自動通知
* **アラート通知対象**：統括人事管理者、現場マネージャー（担当部署のみ）
* **アラート状態管理**：未通知/通知済/確認済の状態管理
* **契約変更履歴**：全ての契約内容変更を記録（変更者、変更日時、変更内容、承認者）

### 出力機能
* **雇用契約書PDF出力**：契約書は必ずPDF形式で出力
  - １つの契約期間につき１枚の契約書を作成
  - 契約内容変更時は既存契約書を無効化し、新規作成
  - 承認番号は各契約書に個別に付与・管理
  - 契約書再作成時は新しい承認番号の入力が必須
* **CSV抽出機能**：指定日時点でのデータをCSV形式で抽出可能
* **抽出項目選択**：CSV抽出時に出力項目を選択可能
* **給与計算用CSV出力**：給与計算に必要な以下の項目を含むCSV形式での出力
  - 時給情報（複数レート対応、適用期間付き）
  - 通勤費（ルート別往復金額、月額定期、上限金額）
  - 社会保険加入フラグ（0:未加入/1:加入）
  - 各種手当（基本手当、職務手当、皆勤手当、その他手当）

### システム性能・可用性
* 可用性/復旧目標（RTO/RPO）: 未定
* 応答性能: 検索・一覧2秒以内（目標）
  - インデックスの適切な設定により高速検索を実現
  - N+1問題の回避（Prismaの include を活用）
  - ページネーション対応（大量データの効率的な取得）
* 監査ログ: 改ざん防止、契約関連イベント追跡
  - audit_logs テーブルに全操作を記録
  - 変更前後の値をJSON形式で保存
  - インデックスによる高速検索
* 監査/コンプライアンス: 個人情報保護法対応
* データベース接続: Supabase Connection Poolingによる効率的な接続管理

### 開発環境要件
* Node.js: ^22.21.0（--experimental-strip-typesサポート必須）
* pnpm: ^10.19.0
* 注意：古いNode.jsバージョンではlintコマンドが失敗します

## 11. 移行/導入

* 現場既存Excel管理からの一括CSVインポート対応
  - Prisma Clientを使用したバルクインサート処理
  - トランザクションによるデータ整合性の保証
  - バリデーションエラー時のロールバック機能
  - インポート結果レポートの生成

## 12. リスク/制約

* フォーム保存動作不具合（勤務条件等）の早期修正が前提
* 書類管理機能が未実装のため、今後開発対象
* 契約更新・雇用期間満了アラートの実装要確認

---

### 付録A: 主な追加項目（2025-10反映）

| 区分    | 追加項目                | 概要                  |
| ----- | ------------------- | ------------------- |
| 従業員登録 | 勤務時間帯・休憩時間帯複数入力     | 数値入力対応、時間帯表示        |
| 従業員登録 | 勤務場所複数              | 部門コード単位管理           |
| 従業員登録 | 有休基準日               | 付与基準日管理             |
| 従業員登録 | 交通費詳細               | ルート別・往復金額・月額定期・上限金額 |
| 契約管理  | 契約更新有無・有期契約基準日・業務内容 | 契約書項目に追加            |
| 契約書   | 承認番号管理              | 契約書個別の承認番号付与・再作成時入力必須 |
| アラート  | 契約更新アラート機能          | 契約期限前通知・リマインダー設定・通知履歴管理 |
| 契約管理  | 契約変更履歴管理            | 変更内容・更新者・承認者の記録・履歴表示 |
| 契約管理  | 契約履歴表示              | 雇用期間・勤務時間・勤務日数・勤務場所・時給・雇用保険・社会保険 |
| 文書管理  | 提出物・預かり品管理          | 提出状況・返却状況の追跡・一覧表示 |
| 一覧画面  | ステータス・勤務場所検索        | チェックボックス一括更新対応      |
| アラート  | 雇用期間終了通知            | 契約書出力で自動解除          |
| 契約書   | 枝番出力                | 契約書出力のたびに枝番増加       |
| **新規追加** | **同時編集制御**            | **最初のアクセス者以外は編集不可**   |
| **新規追加** | **最終更新日時表示**          | **全画面で更新日時・更新者表示**    |
| **新規追加** | **CSV抽出機能**           | **指定日時点・項目選択可能**      |
| **新規追加** | **給与計算用CSV出力**        | **時給・通勤費・社保・各種手当を含む給与計算データ出力**   |
| **新規追加** | **雇用契約書PDF出力**        | **PDF形式での契約書出力必須**    |
| **システム改善** | **個人情報最小化**           | **住所・電話番号情報は保持しない**   |
